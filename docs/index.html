<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VN Stock Sniper - Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a1f2e;
            --bg-card-hover: #242b3d;
            --bg-input: #151a28;
            --border: #2a3148;
            --border-hover: #3d4663;
            --text-primary: #e8edf5;
            --text-secondary: #8892a8;
            --text-muted: #5a6378;
            --green: #22c55e;
            --green-dim: rgba(34,197,94,0.15);
            --red: #ef4444;
            --red-dim: rgba(239,68,68,0.15);
            --yellow: #eab308;
            --yellow-dim: rgba(234,179,8,0.15);
            --blue: #3b82f6;
            --blue-dim: rgba(59,130,246,0.15);
            --purple: #a855f7;
            --purple-dim: rgba(168,85,247,0.15);
            --cyan: #06b6d4;
            --orange: #f97316;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
        }
        .header-inner {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo-icon {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, var(--blue), var(--purple));
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: 700;
        }
        .logo-text { font-size: 1.25rem; font-weight: 700; }
        .logo-sub { font-size: 0.75rem; color: var(--text-secondary); }
        .header-search {
            flex: 1;
            max-width: 400px;
            min-width: 200px;
        }
        .header-search input {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 16px;
            color: var(--text-primary);
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .header-search input:focus {
            border-color: var(--blue);
        }
        .header-search input::placeholder { color: var(--text-muted); }
        .header-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: right;
        }

        /* Main container */
        .main { max-width: 1600px; margin: 0 auto; padding: 20px 24px; }

        /* Stat cards row */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.2s;
            cursor: default;
        }
        .stat-card:hover { border-color: var(--border-hover); transform: translateY(-2px); }
        .stat-icon { font-size: 1.5rem; margin-bottom: 4px; }
        .stat-value { font-size: 1.75rem; font-weight: 700; line-height: 1.2; }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px; }
        .stat-badge {
            display: inline-block;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
        }

        /* Section */
        .section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .section-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
        }
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-body { padding: 20px; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .tab {
            padding: 8px 16px;
            border-radius: 7px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
            transition: all 0.2s;
            border: none;
            background: none;
        }
        .tab:hover { color: var(--text-primary); background: var(--bg-card); }
        .tab.active {
            background: var(--blue);
            color: #fff;
        }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Filter pills */
        .filters {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .filter-pill {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-pill:hover, .filter-pill.active {
            border-color: var(--blue);
            color: var(--blue);
            background: var(--blue-dim);
        }
        .filter-pill .count {
            background: var(--bg-card);
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 4px;
        }

        /* Stock table */
        .stock-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.85rem;
        }
        .stock-table thead th {
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            white-space: nowrap;
            user-select: none;
        }
        .stock-table thead th:hover { color: var(--text-primary); }
        .stock-table thead th.sorted-asc::after { content: ' \2191'; color: var(--blue); }
        .stock-table thead th.sorted-desc::after { content: ' \2193'; color: var(--blue); }
        .stock-table tbody tr {
            cursor: pointer;
            transition: background 0.15s;
        }
        .stock-table tbody tr:hover { background: var(--bg-card-hover); }
        .stock-table tbody td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(42,49,72,0.5);
            white-space: nowrap;
        }

        /* Inline badges */
        .badge-channel {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-green { background: var(--green-dim); color: var(--green); }
        .badge-gray { background: rgba(136,146,168,0.15); color: var(--text-secondary); }
        .badge-red { background: var(--red-dim); color: var(--red); }
        .badge-signal {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-breakout { background: var(--green); color: #000; }
        .badge-momentum { background: var(--blue); color: #fff; }
        .badge-pullback { background: var(--yellow); color: #000; }
        .badge-reversal { background: var(--purple); color: #fff; }

        /* RSI bar */
        .rsi-bar {
            width: 60px; height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            display: inline-block;
            vertical-align: middle;
            margin-left: 6px;
            position: relative;
        }
        .rsi-bar-fill {
            height: 100%;
            border-radius: 3px;
            position: absolute;
            left: 0; top: 0;
        }

        /* Stars */
        .stars-display { color: var(--yellow); letter-spacing: -2px; }

        /* Signal cards */
        .signal-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
        }
        .signal-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .signal-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .signal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .signal-symbol { font-size: 1.1rem; font-weight: 700; }
        .signal-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            text-align: center;
            margin-bottom: 12px;
        }
        .signal-metric-label { font-size: 0.7rem; color: var(--text-muted); }
        .signal-metric-value { font-size: 0.9rem; font-weight: 600; }
        .signal-levels {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.8rem;
        }
        .signal-level {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.03);
        }

        /* Heatmap */
        .heatmap {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 4px;
        }
        .heatmap-cell {
            padding: 8px 4px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.75rem;
        }
        .heatmap-cell:hover { transform: scale(1.05); z-index: 1; }
        .heatmap-symbol { font-weight: 700; font-size: 0.8rem; }
        .heatmap-score { font-size: 0.65rem; opacity: 0.8; }

        /* Gauge */
        .gauge-container {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .gauge-ring {
            width: 100px; height: 100px;
            position: relative;
        }
        .gauge-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .gauge-ring circle {
            fill: none;
            stroke-width: 8;
        }
        .gauge-ring .bg { stroke: var(--bg-secondary); }
        .gauge-ring .fg { stroke-linecap: round; transition: stroke-dashoffset 1s ease; }
        .gauge-value {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            font-weight: 700;
        }
        .gauge-label { font-size: 0.75rem; color: var(--text-secondary); }

        /* Charts row */
        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(4px);
        }
        .modal-overlay.show { display: flex; justify-content: center; align-items: flex-start; }
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            margin: 20px auto;
            animation: modalIn 0.2s ease;
        }
        @keyframes modalIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-close {
            width: 32px; height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }
        .modal-close:hover { background: var(--red-dim); color: var(--red); border-color: var(--red); }
        .modal-body { padding: 24px; }

        /* Indicator grid in modal */
        .ind-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        .ind-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }
        .ind-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .ind-value { font-size: 1.1rem; font-weight: 600; margin-top: 2px; }

        /* Portfolio */
        .portfolio-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        /* AI Report */
        .ai-report-content {
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Watchlist */
        .watchlist-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        .watchlist-star {
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            opacity: 0.3;
        }
        .watchlist-star:hover, .watchlist-star.active { opacity: 1; color: var(--yellow); }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            font-size: 0.85rem;
        }
        .pagination-info { color: var(--text-secondary); }
        .pagination-btns { display: flex; gap: 4px; }
        .pagination-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pagination-btn:hover, .pagination-btn.active { background: var(--blue); color: #fff; border-color: var(--blue); }
        .pagination-btn:disabled { opacity: 0.3; cursor: default; }

        /* Green/Red coloring */
        .c-green { color: var(--green); }
        .c-red { color: var(--red); }
        .c-yellow { color: var(--yellow); }
        .c-blue { color: var(--blue); }
        .c-purple { color: var(--purple); }
        .c-cyan { color: var(--cyan); }
        .c-muted { color: var(--text-muted); }

        /* Responsive */
        @media (max-width: 768px) {
            .main { padding: 12px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .stat-value { font-size: 1.3rem; }
            .header-inner { flex-direction: column; text-align: center; }
            .header-search { max-width: 100%; }
            .signal-cards { grid-template-columns: 1fr; }
            .heatmap { grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); }
            .tabs { flex-wrap: nowrap; }
        }
        </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <div class="header-inner">
        <div class="logo">
            <div class="logo-icon">S</div>
            <div>
                <div class="logo-text">VN Stock Sniper</div>
                <div class="logo-sub">Dashboard Phan tich Co phieu Viet Nam</div>
            </div>
        </div>
        <div class="header-search">
            <input type="text" id="globalSearch" placeholder="Tim kiem ma co phieu... (vd: FPT, VNM, HPG)" autocomplete="off">
        </div>
        <div class="header-time">
            Cap nhat: 06/02/2026 20:07<br>
            10 ma co phieu
        </div>
    </div>
</div>

<div class="main">

<!-- STATS ROW -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">&#x1F7E2;</div>
        <div class="stat-value c-green">5</div>
        <div class="stat-label">Kenh Xanh (Uptrend)</div>
        <div class="stat-badge" style="background:var(--green-dim);color:var(--green)">50.0%</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">&#x26AA;</div>
        <div class="stat-value" style="color:var(--text-secondary)">3</div>
        <div class="stat-label">Kenh Xam (Sideways)</div>
        <div class="stat-badge" style="background:rgba(136,146,168,0.15);color:var(--text-secondary)">30.0%</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">&#x1F534;</div>
        <div class="stat-value c-red">2</div>
        <div class="stat-label">Kenh Do (Downtrend)</div>
        <div class="stat-badge" style="background:var(--red-dim);color:var(--red)">20.0%</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">&#x1F4E2;</div>
        <div class="stat-value c-yellow">4</div>
        <div class="stat-label">Tin hieu MUA</div>
        <div class="stat-badge" style="background:var(--yellow-dim);color:var(--yellow)">BUY</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">&#x2B50;</div>
        <div class="stat-value c-yellow">2</div>
        <div class="stat-label">5 Sao</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">&#x1F4CA;</div>
        <div class="stat-value c-blue">2</div>
        <div class="stat-label">4 Sao</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">&#x1F4C8;</div>
        <div class="stat-value c-cyan">4</div>
        <div class="stat-label">Vol Surge</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">&#x1F50D;</div>
        <div class="stat-value c-purple">2</div>
        <div class="stat-label">BB Squeeze</div>
    </div>
</div>

<!-- CHARTS ROW -->
<div class="charts-row">
    <div class="section" style="margin-bottom:0">
        <div class="section-header"><div class="section-title">Phan bo Kenh</div></div>
        <div class="section-body" style="display:flex;align-items:center;justify-content:center;">
            <div style="width:220px;height:220px;"><canvas id="channelChart"></canvas></div>
        </div>
    </div>
    <div class="section" style="margin-bottom:0">
        <div class="section-header"><div class="section-title">Phan bo Tin hieu</div></div>
        <div class="section-body" style="display:flex;align-items:center;justify-content:center;">
            <div style="width:220px;height:220px;"><canvas id="signalChart"></canvas></div>
        </div>
    </div>
    <div class="section" style="margin-bottom:0">
        <div class="section-header"><div class="section-title">Thi truong</div></div>
        <div class="section-body">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <div class="ind-item">
                    <div class="ind-label">RSI Trung binh</div>
                    <div class="ind-value" style="color:var(--text-primary)">68.5</div>
                </div>
                <div class="ind-item">
                    <div class="ind-label">MFI Trung binh</div>
                    <div class="ind-value">51.0</div>
                </div>
                <div class="ind-item">
                    <div class="ind-label">MACD Bullish</div>
                    <div class="ind-value c-green">5</div>
                </div>
                <div class="ind-item">
                    <div class="ind-label">Phan bo Sao</div>
                    <div class="ind-value" style="font-size:0.85rem">2x5 / 2x4 / 2x3</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MAIN TABS -->
<div class="tabs" id="mainTabs">
    <button class="tab active" data-tab="signals">Tin hieu MUA (4)</button>
    <button class="tab" data-tab="heatmap">Heatmap</button>
    <button class="tab" data-tab="ranking">Bang xep hang</button>
    <button class="tab" data-tab="watchlist">Watchlist</button>
    <button class="tab" data-tab="portfolio">Portfolio</button>
    <button class="tab" data-tab="ai-report">AI Report</button>
</div>

<!-- TAB: SIGNALS -->
<div class="tab-panel active" id="panel-signals">
    <div class="section">
        <div class="section-header">
            <div class="section-title">Tin hieu MUA hom nay</div>
            <div class="filters" id="signalFilters">
                <button class="filter-pill active" data-signal="all">Tat ca<span class="count">4</span></button>
                <button class="filter-pill" data-signal="BREAKOUT">Breakout<span class="count">1</span></button>
                <button class="filter-pill" data-signal="MOMENTUM">Momentum<span class="count">1</span></button>
                <button class="filter-pill" data-signal="PULLBACK">Pullback<span class="count">1</span></button>
                <button class="filter-pill" data-signal="REVERSAL">Reversal<span class="count">1</span></button>
            </div>
        </div>
        <div class="section-body">
            <div class="signal-cards" id="signalCards"></div>
        </div>
    </div>
</div>

<!-- TAB: HEATMAP -->
<div class="tab-panel" id="panel-heatmap">
    <div class="section">
        <div class="section-header">
            <div class="section-title">Heatmap theo Diem (Quality + Momentum)</div>
            <div class="filters" id="heatmapFilters">
                <button class="filter-pill active" data-hm="score">Theo Diem</button>
                <button class="filter-pill" data-hm="rsi">Theo RSI</button>
                <button class="filter-pill" data-hm="volume">Theo Volume</button>
            </div>
        </div>
        <div class="section-body">
            <div class="heatmap" id="heatmapGrid"></div>
        </div>
    </div>
</div>

<!-- TAB: RANKING -->
<div class="tab-panel" id="panel-ranking">
    <div class="section">
        <div class="section-header">
            <div class="section-title">Bang xep hang Co phieu</div>
            <div class="filters" id="channelFilters">
                <button class="filter-pill active" data-channel="all">Tat ca<span class="count">10</span></button>
                <button class="filter-pill" data-channel="XANH">Xanh<span class="count">5</span></button>
                <button class="filter-pill" data-channel="X√ÅM">Xam<span class="count">3</span></button>
                <button class="filter-pill" data-channel="ƒê·ªé">Do<span class="count">2</span></button>
            </div>
        </div>
        <div class="section-body" style="padding:0;overflow-x:auto;">
            <table class="stock-table" id="stockTable">
                <thead>
                    <tr>
                        <th data-sort="index">#</th>
                        <th></th>
                        <th data-sort="symbol">Ma</th>
                        <th data-sort="close">Gia</th>
                        <th data-sort="total_score">Diem</th>
                        <th data-sort="stars">Sao</th>
                        <th data-sort="buy_signal">Tin hieu</th>
                        <th data-sort="channel">Kenh</th>
                        <th data-sort="rsi">RSI</th>
                        <th data-sort="mfi">MFI</th>
                        <th data-sort="vol_ratio">Vol</th>
                        <th data-sort="macd_bullish">MACD</th>
                        <th data-sort="bb_percent">BB%</th>
                    </tr>
                </thead>
                <tbody id="stockTableBody"></tbody>
            </table>
            <div class="pagination" style="padding:12px 20px;">
                <div class="pagination-info" id="pageInfo"></div>
                <div class="pagination-btns" id="pageBtns"></div>
            </div>
        </div>
    </div>
</div>

<!-- TAB: WATCHLIST -->
<div class="tab-panel" id="panel-watchlist">
    <div class="section">
        <div class="section-header">
            <div class="section-title">Watchlist cua ban</div>
            <button class="filter-pill" onclick="clearWatchlist()" style="color:var(--red);border-color:var(--red);">Xoa tat ca</button>
        </div>
        <div class="section-body">
            <div id="watchlistContent"></div>
        </div>
    </div>
</div>

<!-- TAB: PORTFOLIO -->
<div class="tab-panel" id="panel-portfolio">
    <div class="section">
        <div class="section-header">
            <div class="section-title">Portfolio cua ban</div>
        </div>
        <div class="section-body">
            <div class="portfolio-summary">
                <div class="stat-card">
                    <div class="stat-value c-blue">100%</div>
                    <div class="stat-label">Tien mat</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value c-green">+0.00%</div>
                    <div class="stat-label">Tong P&L</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">0</div>
                    <div class="stat-label">Vi the</div>
                </div>
            </div>
            <div style="text-align:center;padding:30px;color:var(--text-muted)"><p>Chua co vi the nao</p><p style="font-size:0.85rem">Dung Telegram Bot de them vi the:</p><code style="color:var(--blue)">/buy VCI 1000 37000</code></div>
        </div>
    </div>
</div>

<!-- TAB: AI REPORT -->
<div class="tab-panel" id="panel-ai-report">
    <div class="section">
        <div class="section-header">
            <div class="section-title">Bao cao Phan tich AI</div>
        </div>
        <div class="section-body">
            <div class="ai-report-content" id="aiReportContent"></div>
        </div>
    </div>
</div>

</div><!-- end main -->

<!-- STOCK DETAIL MODAL -->
<div class="modal-overlay" id="stockModal">
    <div class="modal-content">
        <div class="modal-header">
            <div>
                <div style="font-size:1.2rem;font-weight:700;" id="modalTitle"></div>
                <div style="font-size:0.8rem;color:var(--text-secondary);" id="modalSub"></div>
            </div>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<script>
// === DATA ===
const ALL_STOCKS = [{"symbol": "FPT", "close": 80000, "open": 79000, "high": 82000, "low": 78000, "volume": 5000000, "quality_score": 15, "momentum_score": 10.0, "total_score": 25.0, "stars": 5, "buy_signal": "BREAKOUT", "sell_signal": null, "channel": "üü¢ XANH", "rsi": 55, "mfi": 60, "macd_bullish": true, "macd_accelerating": true, "stoch_k": 65, "stoch_d": 60, "vol_ratio": 1.5, "vol_surge": true, "vol_above_avg": true, "atr": 2000, "atr_percent": 2.5, "bb_percent": 50, "bb_width": 8.0, "bb_squeeze": false, "bb_upper": 85000, "bb_lower": 75000, "bb_mid": 80000, "ma5": 80500, "ma10": 80000, "ma20": 79000, "ma50": 78000, "ma200": 75000, "ma_aligned": true, "above_ma200": true, "above_ma50": true, "above_ma20": true, "lr_slope_pct": 0.1, "channel_position": 60, "is_uptrend_channel": true, "is_sideways_channel": false, "is_downtrend_channel": false, "support": 77000, "resistance": 83000, "lr_upper": 84000, "lr_lower": 76000, "breakout_20": true, "breakout_50": true, "highest_20": 82000, "highest_50": 83000}, {"symbol": "VNM", "close": 85000, "open": 84000, "high": 87000, "low": 83000, "volume": 5100000, "quality_score": 14, "momentum_score": 9.5, "total_score": 23.5, "stars": 5, "buy_signal": "MOMENTUM", "sell_signal": null, "channel": "üü¢ XANH", "rsi": 58, "mfi": 58, "macd_bullish": true, "macd_accelerating": true, "stoch_k": 67, "stoch_d": 62, "vol_ratio": 1.7, "vol_surge": true, "vol_above_avg": true, "atr": 2000, "atr_percent": 2.5, "bb_percent": 55, "bb_width": 8.5, "bb_squeeze": false, "bb_upper": 90000, "bb_lower": 80000, "bb_mid": 85000, "ma5": 85500, "ma10": 85000, "ma20": 84000, "ma50": 83000, "ma200": 80000, "ma_aligned": true, "above_ma200": true, "above_ma50": true, "above_ma20": true, "lr_slope_pct": 0.07, "channel_position": 55, "is_uptrend_channel": true, "is_sideways_channel": false, "is_downtrend_channel": false, "support": 82000, "resistance": 88000, "lr_upper": 89000, "lr_lower": 81000, "breakout_20": true, "breakout_50": false, "highest_20": 87000, "highest_50": 88000}, {"symbol": "HPG", "close": 90000, "open": 89000, "high": 92000, "low": 88000, "volume": 5200000, "quality_score": 13, "momentum_score": 9.0, "total_score": 22.0, "stars": 4, "buy_signal": "PULLBACK", "sell_signal": null, "channel": "üü¢ XANH", "rsi": 61, "mfi": 56, "macd_bullish": true, "macd_accelerating": true, "stoch_k": 69, "stoch_d": 64, "vol_ratio": 1.9, "vol_surge": true, "vol_above_avg": true, "atr": 2000, "atr_percent": 2.5, "bb_percent": 60, "bb_width": 9.0, "bb_squeeze": true, "bb_upper": 95000, "bb_lower": 85000, "bb_mid": 90000, "ma5": 90500, "ma10": 90000, "ma20": 89000, "ma50": 88000, "ma200": 85000, "ma_aligned": true, "above_ma200": true, "above_ma50": true, "above_ma20": true, "lr_slope_pct": 0.04, "channel_position": 50, "is_uptrend_channel": true, "is_sideways_channel": false, "is_downtrend_channel": false, "support": 87000, "resistance": 93000, "lr_upper": 94000, "lr_lower": 86000, "breakout_20": false, "breakout_50": false, "highest_20": 92000, "highest_50": 93000}, {"symbol": "MBB", "close": 95000, "open": 94000, "high": 97000, "low": 93000, "volume": 5300000, "quality_score": 12, "momentum_score": 8.5, "total_score": 20.5, "stars": 4, "buy_signal": null, "sell_signal": null, "channel": "‚ö™ X√ÅM", "rsi": 64, "mfi": 54, "macd_bullish": true, "macd_accelerating": false, "stoch_k": 71, "stoch_d": 66, "vol_ratio": 2.1, "vol_surge": true, "vol_above_avg": true, "atr": 2000, "atr_percent": 2.5, "bb_percent": 65, "bb_width": 9.5, "bb_squeeze": false, "bb_upper": 100000, "bb_lower": 90000, "bb_mid": 95000, "ma5": 95500, "ma10": 95000, "ma20": 94000, "ma50": 93000, "ma200": 90000, "ma_aligned": true, "above_ma200": true, "above_ma50": true, "above_ma20": true, "lr_slope_pct": 0.01, "channel_position": 45, "is_uptrend_channel": true, "is_sideways_channel": true, "is_downtrend_channel": false, "support": 92000, "resistance": 98000, "lr_upper": 99000, "lr_lower": 91000, "breakout_20": false, "breakout_50": false, "highest_20": 97000, "highest_50": 98000}, {"symbol": "TCB", "close": 100000, "open": 99000, "high": 102000, "low": 98000, "volume": 5400000, "quality_score": 11, "momentum_score": 8.0, "total_score": 19.0, "stars": 3, "buy_signal": "REVERSAL", "sell_signal": null, "channel": "üî¥ ƒê·ªé", "rsi": 67, "mfi": 52, "macd_bullish": true, "macd_accelerating": false, "stoch_k": 73, "stoch_d": 68, "vol_ratio": 2.3, "vol_surge": false, "vol_above_avg": true, "atr": 2000, "atr_percent": 2.5, "bb_percent": 70, "bb_width": 10.0, "bb_squeeze": false, "bb_upper": 105000, "bb_lower": 95000, "bb_mid": 100000, "ma5": 100500, "ma10": 100000, "ma20": 99000, "ma50": 98000, "ma200": 95000, "ma_aligned": false, "above_ma200": true, "above_ma50": true, "above_ma20": true, "lr_slope_pct": -0.0199999999999999, "channel_position": 40, "is_uptrend_channel": false, "is_sideways_channel": false, "is_downtrend_channel": true, "support": 97000, "resistance": 103000, "lr_upper": 104000, "lr_lower": 96000, "breakout_20": false, "breakout_50": false, "highest_20": 102000, "highest_50": 103000}, {"symbol": "VCB", "close": 105000, "open": 104000, "high": 107000, "low": 103000, "volume": 5500000, "quality_score": 10, "momentum_score": 7.5, "total_score": 17.5, "stars": 3, "buy_signal": null, "sell_signal": null, "channel": "‚ö™ X√ÅM", "rsi": 70, "mfi": 50, "macd_bullish": false, "macd_accelerating": false, "stoch_k": 75, "stoch_d": 70, "vol_ratio": 2.5, "vol_surge": false, "vol_above_avg": true, "atr": 2000, "atr_percent": 2.5, "bb_percent": 75, "bb_width": 10.5, "bb_squeeze": true, "bb_upper": 110000, "bb_lower": 100000, "bb_mid": 105000, "ma5": 105500, "ma10": 105000, "ma20": 104000, "ma50": 103000, "ma200": 100000, "ma_aligned": false, "above_ma200": true, "above_ma50": true, "above_ma20": false, "lr_slope_pct": -0.0499999999999999, "channel_position": 35, "is_uptrend_channel": false, "is_sideways_channel": true, "is_downtrend_channel": false, "support": 102000, "resistance": 108000, "lr_upper": 109000, "lr_lower": 101000, "breakout_20": false, "breakout_50": false, "highest_20": 107000, "highest_50": 108000}, {"symbol": "ACB", "close": 110000, "open": 109000, "high": 112000, "low": 108000, "volume": 5600000, "quality_score": 9, "momentum_score": 7.0, "total_score": 16.0, "stars": 2, "buy_signal": null, "sell_signal": null, "channel": "üü¢ XANH", "rsi": 73, "mfi": 48, "macd_bullish": false, "macd_accelerating": false, "stoch_k": 77, "stoch_d": 72, "vol_ratio": 2.7, "vol_surge": false, "vol_above_avg": false, "atr": 2000, "atr_percent": 2.5, "bb_percent": 80, "bb_width": 11.0, "bb_squeeze": false, "bb_upper": 115000, "bb_lower": 105000, "bb_mid": 110000, "ma5": 110500, "ma10": 110000, "ma20": 109000, "ma50": 108000, "ma200": 105000, "ma_aligned": false, "above_ma200": true, "above_ma50": false, "above_ma20": false, "lr_slope_pct": -0.0799999999999999, "channel_position": 30, "is_uptrend_channel": false, "is_sideways_channel": false, "is_downtrend_channel": false, "support": 107000, "resistance": 113000, "lr_upper": 114000, "lr_lower": 106000, "breakout_20": false, "breakout_50": false, "highest_20": 112000, "highest_50": 113000}, {"symbol": "SSI", "close": 115000, "open": 114000, "high": 117000, "low": 113000, "volume": 5700000, "quality_score": 8, "momentum_score": 6.5, "total_score": 14.5, "stars": 2, "buy_signal": null, "sell_signal": null, "channel": "üî¥ ƒê·ªé", "rsi": 76, "mfi": 46, "macd_bullish": false, "macd_accelerating": false, "stoch_k": 79, "stoch_d": 74, "vol_ratio": 2.9000000000000004, "vol_surge": false, "vol_above_avg": false, "atr": 2000, "atr_percent": 2.5, "bb_percent": 85, "bb_width": 11.5, "bb_squeeze": false, "bb_upper": 120000, "bb_lower": 110000, "bb_mid": 115000, "ma5": 115500, "ma10": 115000, "ma20": 114000, "ma50": 113000, "ma200": 110000, "ma_aligned": false, "above_ma200": false, "above_ma50": false, "above_ma20": false, "lr_slope_pct": -0.1099999999999999, "channel_position": 25, "is_uptrend_channel": false, "is_sideways_channel": false, "is_downtrend_channel": true, "support": 112000, "resistance": 118000, "lr_upper": 119000, "lr_lower": 111000, "breakout_20": false, "breakout_50": false, "highest_20": 117000, "highest_50": 118000}, {"symbol": "VCI", "close": 120000, "open": 119000, "high": 122000, "low": 118000, "volume": 5800000, "quality_score": 7, "momentum_score": 6.0, "total_score": 13.0, "stars": 1, "buy_signal": null, "sell_signal": null, "channel": "‚ö™ X√ÅM", "rsi": 79, "mfi": 44, "macd_bullish": false, "macd_accelerating": false, "stoch_k": 81, "stoch_d": 76, "vol_ratio": 3.1, "vol_surge": false, "vol_above_avg": false, "atr": 2000, "atr_percent": 2.5, "bb_percent": 90, "bb_width": 12.0, "bb_squeeze": false, "bb_upper": 125000, "bb_lower": 115000, "bb_mid": 120000, "ma5": 120500, "ma10": 120000, "ma20": 119000, "ma50": 118000, "ma200": 115000, "ma_aligned": false, "above_ma200": false, "above_ma50": false, "above_ma20": false, "lr_slope_pct": -0.1399999999999999, "channel_position": 20, "is_uptrend_channel": false, "is_sideways_channel": true, "is_downtrend_channel": false, "support": 117000, "resistance": 123000, "lr_upper": 124000, "lr_lower": 116000, "breakout_20": false, "breakout_50": false, "highest_20": 122000, "highest_50": 123000}, {"symbol": "DGW", "close": 125000, "open": 124000, "high": 127000, "low": 123000, "volume": 5900000, "quality_score": 6, "momentum_score": 5.5, "total_score": 11.5, "stars": 1, "buy_signal": null, "sell_signal": null, "channel": "üü¢ XANH", "rsi": 82, "mfi": 42, "macd_bullish": false, "macd_accelerating": false, "stoch_k": 83, "stoch_d": 78, "vol_ratio": 3.3, "vol_surge": false, "vol_above_avg": false, "atr": 2000, "atr_percent": 2.5, "bb_percent": 95, "bb_width": 12.5, "bb_squeeze": false, "bb_upper": 130000, "bb_lower": 120000, "bb_mid": 125000, "ma5": 125500, "ma10": 125000, "ma20": 124000, "ma50": 123000, "ma200": 120000, "ma_aligned": false, "above_ma200": false, "above_ma50": false, "above_ma20": false, "lr_slope_pct": -0.17, "channel_position": 15, "is_uptrend_channel": false, "is_sideways_channel": false, "is_downtrend_channel": false, "support": 122000, "resistance": 128000, "lr_upper": 129000, "lr_lower": 121000, "breakout_20": false, "breakout_50": false, "highest_20": 127000, "highest_50": 128000}];
const SIGNALS_DATA = [{"symbol": "FPT", "signal": "BREAKOUT", "close": 80000.0, "q": 15.0, "m": 10.0, "stars": 5, "rsi": 55.0, "channel": "üü¢ XANH", "vol_ratio": 1.5, "sl": 76000.0, "tp1": 86000.0, "tp2": 90000.0, "atr": 2000.0}, {"symbol": "VNM", "signal": "MOMENTUM", "close": 85000.0, "q": 14.0, "m": 9.5, "stars": 5, "rsi": 58.0, "channel": "üü¢ XANH", "vol_ratio": 1.7, "sl": 81000.0, "tp1": 91000.0, "tp2": 95000.0, "atr": 2000.0}, {"symbol": "HPG", "signal": "PULLBACK", "close": 90000.0, "q": 13.0, "m": 9.0, "stars": 4, "rsi": 61.0, "channel": "üü¢ XANH", "vol_ratio": 1.9, "sl": 86000.0, "tp1": 96000.0, "tp2": 100000.0, "atr": 2000.0}, {"symbol": "TCB", "signal": "REVERSAL", "close": 100000.0, "q": 11.0, "m": 8.0, "stars": 3, "rsi": 67.0, "channel": "üî¥ ƒê·ªé", "vol_ratio": 2.3, "sl": 96000.0, "tp1": 106000.0, "tp2": 110000.0, "atr": 2000.0}];
const AI_REPORT = ``;

// === STATE ===
let currentTab = 'signals';
let rankingFilter = 'all';
let signalFilter = 'all';
let heatmapMode = 'score';
let sortCol = 'total_score';
let sortDir = 'desc';
let currentPage = 1;
const PAGE_SIZE = 25;
let watchlist = JSON.parse(localStorage.getItem('vn_watchlist') || '[]');

// === UTILS ===
const n = v => Number(v || 0);
const f1 = v => n(v).toFixed(1);
const f2 = v => n(v).toFixed(2);
const loc = v => n(v).toLocaleString('vi-VN');
const pct = (v) => { const val = n(v); return (val >= 0 ? '+' : '') + val.toFixed(1) + '%'; };

function getRsiColor(rsi) {
    if (rsi > 70) return 'var(--red)';
    if (rsi < 30) return 'var(--green)';
    return 'var(--text-primary)';
}

function getChannelBadge(ch) {
    if (!ch) return '<span class="badge-channel badge-gray">-</span>';
    const clean = ch.replace(/[^A-Za-z√Ä-·ªπ ]/g, '').trim();
    if (ch.includes('XANH')) return '<span class="badge-channel badge-green">' + clean + '</span>';
    if (ch.includes('ƒê·ªé')) return '<span class="badge-channel badge-red">' + clean + '</span>';
    return '<span class="badge-channel badge-gray">' + clean + '</span>';
}

function getSignalBadge(sig) {
    if (!sig) return '-';
    const cls = {'BREAKOUT':'badge-breakout','MOMENTUM':'badge-momentum','PULLBACK':'badge-pullback','REVERSAL':'badge-reversal'}[sig] || '';
    return '<span class="badge-signal ' + cls + '">' + sig + '</span>';
}

function getStars(n) {
    return '<span class="stars-display">' + '&#11088;'.repeat(Math.min(n, 5)) + '</span>';
}

function getRsiBar(rsi) {
    const w = Math.min(rsi, 100);
    const color = rsi > 70 ? 'var(--red)' : rsi < 30 ? 'var(--green)' : 'var(--blue)';
    return f1(rsi) + '<span class="rsi-bar"><span class="rsi-bar-fill" style="width:' + w + '%;background:' + color + '"></span></span>';
}

function isInWatchlist(symbol) {
    return watchlist.includes(symbol);
}

function toggleWatchlist(symbol, e) {
    if (e) e.stopPropagation();
    const idx = watchlist.indexOf(symbol);
    if (idx >= 0) watchlist.splice(idx, 1);
    else watchlist.push(symbol);
    localStorage.setItem('vn_watchlist', JSON.stringify(watchlist));
    renderCurrentTab();
}

function clearWatchlist() {
    watchlist = [];
    localStorage.setItem('vn_watchlist', JSON.stringify(watchlist));
    renderCurrentTab();
}

// === TABS ===
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        document.getElementById('panel-' + currentTab).classList.add('active');
        renderCurrentTab();
    });
});

function renderCurrentTab() {
    if (currentTab === 'signals') renderSignals();
    else if (currentTab === 'heatmap') renderHeatmap();
    else if (currentTab === 'ranking') renderRanking();
    else if (currentTab === 'watchlist') renderWatchlist();
    else if (currentTab === 'ai-report') renderAIReport();
}

// === SIGNAL FILTERS ===
document.querySelectorAll('#signalFilters .filter-pill').forEach(pill => {
    pill.addEventListener('click', () => {
        document.querySelectorAll('#signalFilters .filter-pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        signalFilter = pill.dataset.signal;
        renderSignals();
    });
});

// === CHANNEL FILTERS ===
document.querySelectorAll('#channelFilters .filter-pill').forEach(pill => {
    pill.addEventListener('click', () => {
        document.querySelectorAll('#channelFilters .filter-pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        rankingFilter = pill.dataset.channel;
        currentPage = 1;
        renderRanking();
    });
});

// === HEATMAP FILTERS ===
document.querySelectorAll('#heatmapFilters .filter-pill').forEach(pill => {
    pill.addEventListener('click', () => {
        document.querySelectorAll('#heatmapFilters .filter-pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        heatmapMode = pill.dataset.hm;
        renderHeatmap();
    });
});

// === RENDER: SIGNALS ===
function renderSignals() {
    const container = document.getElementById('signalCards');
    let data = SIGNALS_DATA;
    if (signalFilter !== 'all') data = data.filter(s => s.signal === signalFilter);

    if (data.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">Khong co tin hieu MUA' + (signalFilter !== 'all' ? ' loai ' + signalFilter : '') + '</div>';
        return;
    }

    container.innerHTML = data.map(s => {
        const slPct = s.close > 0 ? ((s.sl - s.close) / s.close * 100).toFixed(1) : 0;
        const tp1Pct = s.close > 0 ? ((s.tp1 - s.close) / s.close * 100).toFixed(1) : 0;
        const tp2Pct = s.close > 0 ? ((s.tp2 - s.close) / s.close * 100).toFixed(1) : 0;
        const sigCls = {'BREAKOUT':'badge-breakout','MOMENTUM':'badge-momentum','PULLBACK':'badge-pullback','REVERSAL':'badge-reversal'}[s.signal] || '';

        return `<div class="signal-card" onclick="showStockDetail('${s.symbol}')">
            <div class="signal-card-header">
                <div>
                    <span class="signal-symbol">${s.symbol}</span>
                    <span class="stars-display" style="margin-left:8px">${'&#11088;'.repeat(s.stars)}</span>
                </div>
                <span class="badge-signal ${sigCls}">${s.signal}</span>
            </div>
            <div class="signal-metrics">
                <div><div class="signal-metric-label">Gia</div><div class="signal-metric-value">${loc(s.close)}</div></div>
                <div><div class="signal-metric-label">Q/M</div><div class="signal-metric-value">${n(s.q).toFixed(0)}/${n(s.m).toFixed(0)}</div></div>
                <div><div class="signal-metric-label">RSI</div><div class="signal-metric-value" style="color:${getRsiColor(s.rsi)}">${f1(s.rsi)}</div></div>
            </div>
            <div class="signal-levels">
                <div class="signal-level"><span>Entry</span><span style="font-weight:600">${loc(s.close)}</span></div>
                <div class="signal-level"><span>Stop Loss</span><span class="c-red">${loc(s.sl)} (${slPct}%)</span></div>
                <div class="signal-level"><span>Target 1</span><span class="c-green">${loc(s.tp1)} (+${tp1Pct}%)</span></div>
                <div class="signal-level"><span>Target 2</span><span class="c-green">${loc(s.tp2)} (+${tp2Pct}%)</span></div>
            </div>
        </div>`;
    }).join('');
}

// === RENDER: HEATMAP ===
function renderHeatmap() {
    const container = document.getElementById('heatmapGrid');
    const stocks = [...ALL_STOCKS].sort((a, b) => n(b.total_score) - n(a.total_score));

    container.innerHTML = stocks.map(s => {
        let val, maxVal, label;
        if (heatmapMode === 'rsi') {
            val = n(s.rsi);
            maxVal = 100;
            label = f1(val);
        } else if (heatmapMode === 'volume') {
            val = Math.min(n(s.vol_ratio), 3);
            maxVal = 3;
            label = f1(s.vol_ratio) + 'x';
        } else {
            val = n(s.total_score);
            maxVal = 40;
            label = n(val).toFixed(0);
        }

        let bgColor;
        if (heatmapMode === 'rsi') {
            if (val > 70) bgColor = 'rgba(239,68,68,0.5)';
            else if (val > 60) bgColor = 'rgba(239,68,68,0.25)';
            else if (val < 30) bgColor = 'rgba(34,197,94,0.5)';
            else if (val < 40) bgColor = 'rgba(34,197,94,0.25)';
            else bgColor = 'rgba(59,130,246,0.2)';
        } else {
            const ratio = Math.min(val / maxVal, 1);
            if (ratio > 0.7) bgColor = 'rgba(34,197,94,' + (0.2 + ratio * 0.4) + ')';
            else if (ratio > 0.4) bgColor = 'rgba(59,130,246,' + (0.15 + ratio * 0.3) + ')';
            else bgColor = 'rgba(136,146,168,' + (0.1 + ratio * 0.15) + ')';
        }

        return `<div class="heatmap-cell" style="background:${bgColor}" onclick="showStockDetail('${s.symbol}')">
            <div class="heatmap-symbol">${s.symbol}</div>
            <div class="heatmap-score">${label}</div>
        </div>`;
    }).join('');
}

// === RENDER: RANKING ===
function renderRanking() {
    let stocks = [...ALL_STOCKS];

    // Filter by channel
    if (rankingFilter !== 'all') {
        stocks = stocks.filter(s => (s.channel || '').includes(rankingFilter));
    }

    // Filter by search
    const searchVal = document.getElementById('globalSearch').value.toUpperCase().trim();
    if (searchVal) {
        stocks = stocks.filter(s => (s.symbol || '').toUpperCase().includes(searchVal));
    }

    // Sort
    stocks.sort((a, b) => {
        let va = a[sortCol], vb = b[sortCol];
        if (typeof va === 'string') va = va || '';
        if (typeof vb === 'string') vb = vb || '';
        if (typeof va === 'number' || typeof vb === 'number') {
            va = n(va); vb = n(vb);
        }
        if (sortDir === 'asc') return va > vb ? 1 : va < vb ? -1 : 0;
        return va < vb ? 1 : va > vb ? -1 : 0;
    });

    // Pagination
    const total = stocks.length;
    const totalPages = Math.ceil(total / PAGE_SIZE);
    if (currentPage > totalPages) currentPage = totalPages || 1;
    const start = (currentPage - 1) * PAGE_SIZE;
    const pageStocks = stocks.slice(start, start + PAGE_SIZE);

    const tbody = document.getElementById('stockTableBody');
    tbody.innerHTML = pageStocks.map((s, i) => {
        const idx = start + i + 1;
        const wlActive = isInWatchlist(s.symbol) ? 'active' : '';
        return `<tr onclick="showStockDetail('${s.symbol}')">
            <td style="color:var(--text-muted)">${idx}</td>
            <td><span class="watchlist-star ${wlActive}" onclick="toggleWatchlist('${s.symbol}', event)">&#9733;</span></td>
            <td><strong>${s.symbol}</strong></td>
            <td>${loc(s.close)}</td>
            <td><strong>${n(s.total_score).toFixed(0)}</strong> <span style="font-size:0.7rem;color:var(--text-muted)">${n(s.quality_score).toFixed(0)}/${n(s.momentum_score).toFixed(0)}</span></td>
            <td>${getStars(n(s.stars))}</td>
            <td>${getSignalBadge(s.buy_signal)}</td>
            <td>${getChannelBadge(s.channel)}</td>
            <td style="color:${getRsiColor(n(s.rsi))}">${getRsiBar(n(s.rsi))}</td>
            <td>${f1(s.mfi)}</td>
            <td style="color:${n(s.vol_ratio) > 1.5 ? 'var(--green)' : 'var(--text-primary)'}">${f1(s.vol_ratio)}x</td>
            <td style="color:${s.macd_bullish ? 'var(--green)' : 'var(--red)'}">${s.macd_bullish ? 'Bull' : 'Bear'}</td>
            <td>${f1(s.bb_percent)}%</td>
        </tr>`;
    }).join('');

    // Update sort headers
    document.querySelectorAll('.stock-table thead th').forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
        if (th.dataset.sort === sortCol) th.classList.add('sorted-' + sortDir);
    });

    // Pagination info
    document.getElementById('pageInfo').textContent = `Hien thi ${start + 1}-${Math.min(start + PAGE_SIZE, total)} / ${total} ma`;

    // Pagination buttons
    const pageBtns = document.getElementById('pageBtns');
    let btnsHtml = '';
    btnsHtml += `<button class="pagination-btn" onclick="goPage(1)" ${currentPage === 1 ? 'disabled' : ''}>&laquo;</button>`;
    btnsHtml += `<button class="pagination-btn" onclick="goPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&lsaquo;</button>`;

    let startP = Math.max(1, currentPage - 2);
    let endP = Math.min(totalPages, currentPage + 2);
    for (let p = startP; p <= endP; p++) {
        btnsHtml += `<button class="pagination-btn ${p === currentPage ? 'active' : ''}" onclick="goPage(${p})">${p}</button>`;
    }

    btnsHtml += `<button class="pagination-btn" onclick="goPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>&rsaquo;</button>`;
    btnsHtml += `<button class="pagination-btn" onclick="goPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>&raquo;</button>`;
    pageBtns.innerHTML = btnsHtml;
}

function goPage(p) {
    currentPage = Math.max(1, p);
    renderRanking();
}

// Table sorting
document.querySelectorAll('.stock-table thead th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
        const col = th.dataset.sort;
        if (sortCol === col) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
        else { sortCol = col; sortDir = 'desc'; }
        currentPage = 1;
        renderRanking();
    });
});

// === RENDER: WATCHLIST ===
function renderWatchlist() {
    const container = document.getElementById('watchlistContent');
    if (watchlist.length === 0) {
        container.innerHTML = '<div class="watchlist-empty">Chua co ma nao trong Watchlist.<br><br>Bam <span style="color:var(--yellow)">&#9733;</span> trong Bang xep hang de them ma vao Watchlist.</div>';
        return;
    }

    const wlStocks = ALL_STOCKS.filter(s => watchlist.includes(s.symbol));
    if (wlStocks.length === 0) {
        container.innerHTML = '<div class="watchlist-empty">Khong tim thay du lieu cho cac ma trong Watchlist.</div>';
        return;
    }

    let html = '<div style="overflow-x:auto;"><table class="stock-table"><thead><tr>';
    html += '<th>Ma</th><th>Gia</th><th>Diem</th><th>Sao</th><th>Tin hieu</th><th>Kenh</th><th>RSI</th><th>MFI</th><th>Vol</th><th></th>';
    html += '</tr></thead><tbody>';

    wlStocks.forEach(s => {
        html += `<tr onclick="showStockDetail('${s.symbol}')" style="cursor:pointer">
            <td><strong>${s.symbol}</strong></td>
            <td>${loc(s.close)}</td>
            <td>${n(s.total_score).toFixed(0)}</td>
            <td>${getStars(n(s.stars))}</td>
            <td>${getSignalBadge(s.buy_signal)}</td>
            <td>${getChannelBadge(s.channel)}</td>
            <td style="color:${getRsiColor(n(s.rsi))}">${f1(s.rsi)}</td>
            <td>${f1(s.mfi)}</td>
            <td>${f1(s.vol_ratio)}x</td>
            <td><span class="watchlist-star active" onclick="toggleWatchlist('${s.symbol}', event)">&#9733;</span></td>
        </tr>`;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// === RENDER: AI REPORT ===
function renderAIReport() {
    document.getElementById('aiReportContent').textContent = AI_REPORT || 'Chua co bao cao AI. Chay workflow de tao bao cao.';
}

// === STOCK DETAIL MODAL ===
function showStockDetail(symbol) {
    const stock = ALL_STOCKS.find(s => s.symbol === symbol);
    if (!stock) return;

    document.getElementById('modalTitle').textContent = symbol;
    document.getElementById('modalSub').textContent = (stock.channel || '') + ' | Q:' + n(stock.quality_score).toFixed(0) + ' M:' + n(stock.momentum_score).toFixed(0) + ' | ' + n(stock.stars) + ' Sao';

    let html = '';

    // Top stats
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px;">';
    html += '<div class="ind-item"><div class="ind-label">Gia hien tai</div><div class="ind-value">' + loc(stock.close) + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">Quality Score</div><div class="ind-value c-blue">' + n(stock.quality_score).toFixed(0) + '/25</div></div>';
    html += '<div class="ind-item"><div class="ind-label">Momentum Score</div><div class="ind-value c-purple">' + n(stock.momentum_score).toFixed(0) + '/15</div></div>';
    html += '<div class="ind-item"><div class="ind-label">Tong diem</div><div class="ind-value c-green">' + n(stock.total_score).toFixed(0) + '/40</div></div>';
    html += '<div class="ind-item"><div class="ind-label">Sao</div><div class="ind-value">' + getStars(n(stock.stars)) + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">Tin hieu</div><div class="ind-value">' + getSignalBadge(stock.buy_signal) + '</div></div>';
    html += '</div>';

    // Trend & Channel
    html += '<h6 style="color:var(--text-secondary);margin-bottom:10px;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.5px">Xu huong & Kenh gia</h6>';
    html += '<div class="ind-grid">';
    html += '<div class="ind-item"><div class="ind-label">Kenh</div><div class="ind-value">' + getChannelBadge(stock.channel) + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">LR Slope %</div><div class="ind-value">' + f2(stock.lr_slope_pct) + '%</div></div>';
    html += '<div class="ind-item"><div class="ind-label">Channel Pos</div><div class="ind-value">' + f1(stock.channel_position) + '%</div></div>';
    html += '<div class="ind-item"><div class="ind-label">MA Aligned</div><div class="ind-value" style="color:' + (stock.ma_aligned ? 'var(--green)' : 'var(--red)') + '">' + (stock.ma_aligned ? 'YES' : 'No') + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">Above MA200</div><div class="ind-value" style="color:' + (stock.above_ma200 ? 'var(--green)' : 'var(--red)') + '">' + (stock.above_ma200 ? 'YES' : 'No') + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">Above MA50</div><div class="ind-value" style="color:' + (stock.above_ma50 ? 'var(--green)' : 'var(--red)') + '">' + (stock.above_ma50 ? 'YES' : 'No') + '</div></div>';
    html += '</div>';

    // Moving Averages
    html += '<h6 style="color:var(--text-secondary);margin-bottom:10px;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.5px">Moving Averages</h6>';
    html += '<div class="ind-grid">';
    ['ma5','ma10','ma20','ma50','ma200'].forEach(k => {
        const val = n(stock[k]);
        const aboveMA = n(stock.close) >= val;
        html += '<div class="ind-item"><div class="ind-label">' + k.toUpperCase() + '</div><div class="ind-value" style="color:' + (aboveMA ? 'var(--green)' : 'var(--red)') + '">' + loc(val) + '</div></div>';
    });
    html += '</div>';

    // Momentum
    html += '<h6 style="color:var(--text-secondary);margin-bottom:10px;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.5px">Momentum</h6>';
    html += '<div class="ind-grid">';
    html += '<div class="ind-item"><div class="ind-label">RSI (14)</div><div class="ind-value" style="color:' + getRsiColor(n(stock.rsi)) + '">' + f1(stock.rsi) + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">MFI</div><div class="ind-value" style="color:' + (n(stock.mfi) > 50 ? 'var(--green)' : 'var(--red)') + '">' + f1(stock.mfi) + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">MACD</div><div class="ind-value" style="color:' + (stock.macd_bullish ? 'var(--green)' : 'var(--red)') + '">' + (stock.macd_bullish ? 'Bullish' : 'Bearish') + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">MACD Accel</div><div class="ind-value" style="color:' + (stock.macd_accelerating ? 'var(--green)' : 'var(--red)') + '">' + (stock.macd_accelerating ? 'Tang toc' : 'Giam toc') + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">Stoch K</div><div class="ind-value">' + f1(stock.stoch_k) + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">Stoch D</div><div class="ind-value">' + f1(stock.stoch_d) + '</div></div>';
    html += '</div>';

    // Volume & Volatility
    html += '<h6 style="color:var(--text-secondary);margin-bottom:10px;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.5px">Volume & Bien dong</h6>';
    html += '<div class="ind-grid">';
    html += '<div class="ind-item"><div class="ind-label">Vol Ratio</div><div class="ind-value" style="color:' + (n(stock.vol_ratio) > 1.5 ? 'var(--green)' : 'var(--text-primary)') + '">' + f2(stock.vol_ratio) + 'x</div></div>';
    html += '<div class="ind-item"><div class="ind-label">Vol Surge</div><div class="ind-value" style="color:' + (stock.vol_surge ? 'var(--green)' : 'var(--text-muted)') + '">' + (stock.vol_surge ? 'YES' : 'No') + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">ATR %</div><div class="ind-value">' + f2(stock.atr_percent) + '%</div></div>';
    html += '<div class="ind-item"><div class="ind-label">BB %</div><div class="ind-value">' + f1(stock.bb_percent) + '%</div></div>';
    html += '<div class="ind-item"><div class="ind-label">BB Squeeze</div><div class="ind-value" style="color:' + (stock.bb_squeeze ? 'var(--yellow)' : 'var(--text-muted)') + '">' + (stock.bb_squeeze ? 'YES' : 'No') + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">BB Width</div><div class="ind-value">' + f2(stock.bb_width) + '%</div></div>';
    html += '</div>';

    // Support / Resistance
    html += '<h6 style="color:var(--text-secondary);margin-bottom:10px;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.5px">Ho tro & Khang cu</h6>';
    html += '<div class="ind-grid">';
    html += '<div class="ind-item"><div class="ind-label">Support</div><div class="ind-value c-green">' + loc(stock.support) + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">Resistance</div><div class="ind-value c-red">' + loc(stock.resistance) + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">BB Lower</div><div class="ind-value c-green">' + loc(stock.bb_lower) + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">BB Upper</div><div class="ind-value c-red">' + loc(stock.bb_upper) + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">LR Lower</div><div class="ind-value c-green">' + loc(stock.lr_lower) + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">LR Upper</div><div class="ind-value c-red">' + loc(stock.lr_upper) + '</div></div>';
    html += '</div>';

    // Breakout Status
    html += '<h6 style="color:var(--text-secondary);margin-bottom:10px;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.5px">Breakout Status</h6>';
    html += '<div class="ind-grid">';
    html += '<div class="ind-item"><div class="ind-label">Breakout 20D</div><div class="ind-value" style="color:' + (stock.breakout_20 ? 'var(--green)' : 'var(--text-muted)') + '">' + (stock.breakout_20 ? 'YES' : 'No') + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">Breakout 50D</div><div class="ind-value" style="color:' + (stock.breakout_50 ? 'var(--green)' : 'var(--text-muted)') + '">' + (stock.breakout_50 ? 'YES' : 'No') + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">High 20D</div><div class="ind-value">' + loc(stock.highest_20) + '</div></div>';
    html += '<div class="ind-item"><div class="ind-label">High 50D</div><div class="ind-value">' + loc(stock.highest_50) + '</div></div>';
    html += '</div>';

    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('stockModal').classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    document.getElementById('stockModal').classList.remove('show');
    document.body.style.overflow = '';
}

document.getElementById('stockModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeModal();
});

// === SEARCH ===
document.getElementById('globalSearch').addEventListener('input', function() {
    if (currentTab === 'ranking') {
        currentPage = 1;
        renderRanking();
    } else {
        // Switch to ranking tab for search
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        currentTab = 'ranking';
        document.querySelector('[data-tab="ranking"]').classList.add('active');
        document.getElementById('panel-ranking').classList.add('active');
        currentPage = 1;
        renderRanking();
    }
});

// === CHARTS ===
function initCharts() {
    // Channel Distribution
    const ctxChannel = document.getElementById('channelChart').getContext('2d');
    new Chart(ctxChannel, {
        type: 'doughnut',
        data: {
            labels: ['Xanh (Uptrend)', 'Xam (Sideways)', 'Do (Downtrend)'],
            datasets: [{ data: [5, 3, 2], backgroundColor: ['#22c55e', '#8892a8', '#ef4444'], borderWidth: 0, borderRadius: 4 }]
        },
        options: {
            responsive: true, maintainAspectRatio: true,
            cutout: '65%',
            plugins: {
                legend: { position: 'bottom', labels: { color: '#8892a8', padding: 12, font: { size: 11 } } }
            }
        }
    });

    // Signal Distribution
    const ctxSignal = document.getElementById('signalChart').getContext('2d');
    new Chart(ctxSignal, {
        type: 'doughnut',
        data: {
            labels: ['Breakout', 'Momentum', 'Pullback', 'Reversal'],
            datasets: [{ data: [1, 1, 1, 1], backgroundColor: ['#22c55e', '#3b82f6', '#eab308', '#a855f7'], borderWidth: 0, borderRadius: 4 }]
        },
        options: {
            responsive: true, maintainAspectRatio: true,
            cutout: '65%',
            plugins: {
                legend: { position: 'bottom', labels: { color: '#8892a8', padding: 12, font: { size: 11 } } }
            }
        }
    });
}

// === INIT ===
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    renderSignals();
    renderAIReport();
});
</script>

</body>
</html>